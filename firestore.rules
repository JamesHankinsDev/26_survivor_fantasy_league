rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Is league member (by UID in members array)
    function isLeagueMember(leagueId) {
      return isAuthenticated() &&
        request.auth.uid in get(/databases/$(database)/documents/leagues/$(leagueId)).data.members;
    }

    // Helper: Is league owner
    function isLeagueOwner(leagueId) {
      return isAuthenticated() &&
        request.auth.uid == get(/databases/$(database)/documents/leagues/$(leagueId)).data.ownerId;
    }

    // Helper: check if UID is in memberDetails array of objects (up to 10 members)
    function memberDetailsHasUser(arr, uid) {
      return arr.size() > 0 && (
        arr[0].userId == uid
        || (arr.size() > 1 && arr[1].userId == uid)
        || (arr.size() > 2 && arr[2].userId == uid)
        || (arr.size() > 3 && arr[3].userId == uid)
        || (arr.size() > 4 && arr[4].userId == uid)
        || (arr.size() > 5 && arr[5].userId == uid)
        || (arr.size() > 6 && arr[6].userId == uid)
        || (arr.size() > 7 && arr[7].userId == uid)
        || (arr.size() > 8 && arr[8].userId == uid)
        || (arr.size() > 9 && arr[9].userId == uid)
      );
    }
    
    // ========================================
    // LEAGUES COLLECTION
    // ========================================
    match /leagues/{leagueId} {
      // Read: owner or member
      allow read: if isAuthenticated() &&
        (request.auth.uid == resource.data.ownerId ||
         request.auth.uid in resource.data.members);

      // Create: owner only
      allow create: if isAuthenticated() &&
        request.auth.uid == request.resource.data.ownerId;

      // Update: owner, member, or joining
      allow update: if (
        // Owner or member can update
        isAuthenticated() && (
          request.auth.uid == resource.data.ownerId ||
          request.auth.uid in resource.data.members
        )
        // Or: joining by adding self to members
        || (
          isAuthenticated() &&
          !(request.auth.uid in resource.data.members) &&
          request.resource.data.members.hasAll(resource.data.members.concat([request.auth.uid])) &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members'])
        )
        // Or: joining by adding self to memberDetails
        || (
          isAuthenticated() &&
          !memberDetailsHasUser(resource.data.memberDetails, request.auth.uid) &&
          memberDetailsHasUser(request.resource.data.memberDetails, request.auth.uid) &&
          request.resource.data.memberDetails.size() == resource.data.memberDetails.size() + 1 &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberDetails'])
        )
      );
      
      // Delete: Only the league owner can delete
      allow delete: if isAuthenticated() && 
                       request.auth.uid == resource.data.ownerId;
      
      // ========================================
      // LEAGUE SUB-COLLECTIONS: SEASONS
      // ========================================
      match /seasons/{seasonNumber} {
        // Allow members to read season data
        allow read: if isLeagueMember(leagueId);
        
        // ========================================
        // ELIMINATED CASTAWAYS (League-Specific)
        // ========================================
        match /eliminated/{castawayId} {
          // Members can read eliminations
          allow read: if isLeagueMember(leagueId);
          
          // Only league owner can write (add/remove eliminations)
          allow write: if isLeagueOwner(leagueId);
        }
        
        // ========================================
        // EPISODE EVENTS (League-Specific)
        // ========================================
        match /episodes/{episodeId} {
          // Members can read episode events/scores
          allow read: if isLeagueMember(leagueId);
          
          // Only league owner can write episode data
          allow write: if isLeagueOwner(leagueId);
        }
        
        // ========================================
        // CASTAWAYS (if stored per league)
        // ========================================
        match /castaways/{castawayId} {
          // Members can read castaway data
          allow read: if isLeagueMember(leagueId);
          
          // Only league owner can write castaway data
          allow write: if isLeagueOwner(leagueId);
        }
      }
      
      // ========================================
      // LEAGUE MESSAGE BOARD
      // ========================================
      match /messages/{messageId} {
        // All league members can read messages
        allow read: if isLeagueMember(leagueId);
        
        // League members can create messages (must be author)
        allow create: if isLeagueMember(leagueId) &&
                         request.auth.uid == request.resource.data.authorId;
        
        // Authors can update their own messages
        allow update: if isLeagueMember(leagueId) &&
                         request.auth.uid == resource.data.authorId;
        
        // Authors can delete their own messages OR league owner can delete any message
        allow delete: if isLeagueMember(leagueId) &&
                         (request.auth.uid == resource.data.authorId ||
                          isLeagueOwner(leagueId));
      }
    }
    
    // ========================================
    // USERS COLLECTION (if you add user profiles)
    // ========================================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can write their own profile
      allow write: if isAuthenticated() && request.auth.uid == userId;
      
      // ========================================
      // USER NOTIFICATIONS SUBCOLLECTION
      // ========================================
      match /notifications/{notificationId} {
        // Users can only read their own notifications
        allow read: if isAuthenticated() && request.auth.uid == userId;
        
        // Notifications should ideally be created by backend/cloud functions
        // For now, allow authenticated users to create notifications
        // TODO: Restrict to cloud functions only when implemented
        allow create: if isAuthenticated();
        
        // Users can update their own notifications (e.g., mark as read)
        // Only allow updating the 'read' field
        allow update: if isAuthenticated() && 
                         request.auth.uid == userId &&
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
        
        // Users can delete their own notifications
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
    }
    
    // ========================================
    // GLOBAL SEASONS COLLECTION (Legacy - if still used)
    // ========================================
    // Note: You may want to remove this if you've fully migrated to league-specific data
    match /seasons/{seasonNumber} {
      // Allow authenticated users to read season info
      allow read: if isAuthenticated();
      
      // No one can write to global seasons (deprecated)
      allow write: if false;
      
      match /eliminated/{castawayId} {
        allow read: if isAuthenticated();
        allow write: if false; // Deprecated - use league-specific instead
      }
      
      match /episodes/{episodeId} {
        allow read: if isAuthenticated();
        allow write: if false; // Deprecated - use league-specific instead
      }
      
      match /castaways/{castawayId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }
  }
}
